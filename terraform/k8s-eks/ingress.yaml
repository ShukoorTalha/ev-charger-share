# Application Load Balancer Ingress for EKS
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: evchargershare-ingress
  namespace: evchargershare
  annotations:
    # AWS Load Balancer Controller annotations
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/load-balancer-name: evchargershare-alb
    
    # Health check settings
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    
    # SSL and HTTPS settings (uncomment when you have SSL certificate)
    # alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    # alb.ingress.kubernetes.io/ssl-redirect: '443'
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/cert-id
    
    # Security settings
    alb.ingress.kubernetes.io/security-groups: sg-xxxxxxxxx  # Will be replaced by deployment script
    
    # Load balancer attributes
    alb.ingress.kubernetes.io/load-balancer-attributes: |
      idle_timeout.timeout_seconds=60
      routing.http2.enabled=true
      access_logs.s3.enabled=false
    
    # Target group attributes
    alb.ingress.kubernetes.io/target-group-attributes: |
      stickiness.enabled=false
      deregistration_delay.timeout_seconds=60
      load_balancing.algorithm.type=round_robin
    
    # Tags for the load balancer
    alb.ingress.kubernetes.io/tags: |
      Environment=dev
      Project=ev-chargershare
      ManagedBy=kubernetes
spec:
  rules:
  - http:
      paths:
      # API routes - backend service
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 5000
      - path: /health
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 5000
      # Frontend routes - catch all other paths
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80

---
# Alternative: NGINX Ingress (if you prefer NGINX over ALB)
# Uncomment this section and comment out the ALB ingress above if you want to use NGINX
# 
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: evchargershare-nginx-ingress
#   namespace: evchargershare
#   annotations:
#     kubernetes.io/ingress.class: nginx
#     nginx.ingress.kubernetes.io/rewrite-target: /
#     nginx.ingress.kubernetes.io/ssl-redirect: "false"
#     nginx.ingress.kubernetes.io/use-regex: "true"
#     nginx.ingress.kubernetes.io/proxy-body-size: "50m"
#     nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
#     nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
#     # SSL certificate (uncomment when you have SSL)
#     # cert-manager.io/cluster-issuer: "letsencrypt-prod"
#     # nginx.ingress.kubernetes.io/ssl-redirect: "true"
# spec:
#   # TLS configuration (uncomment when you have SSL)
#   # tls:
#   # - hosts:
#   #   - your-domain.com
#   #   secretName: evchargershare-tls
#   rules:
#   # - host: your-domain.com  # Uncomment and set your domain
#   - http:
#       paths:
#       # API routes
#       - path: /api
#         pathType: Prefix
#         backend:
#           service:
#             name: backend-service
#             port:
#               number: 5000
#       - path: /health
#         pathType: Prefix
#         backend:
#           service:
#             name: backend-service
#             port:
#               number: 5000
#       # Frontend routes
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: frontend-service
#             port:
#               number: 80
